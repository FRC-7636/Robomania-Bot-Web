{% extends "base.html" %}
{% load static %}
{% load compress %}

{% block head %}
    {% compress css %}
    <link rel="stylesheet" href="{% static 'css/Meetings/index.css' %}">
    {% endcompress %}
    {% compress js %}
    <script src="{% static "js/Meetings/index.js" %}"></script>
    {% endcompress %}
    {% if meeting.description %}
        <!-- Inject description as HTML content -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js" defer></script>
        <script>
        document.addEventListener("DOMContentLoaded", function() {
            let converter = new showdown.Converter(
                {
                    simplifiedAutoLink: true,
                    excludeTrailingPunctuationFromURLs: true,
                    strikethrough: true,
                    simpleLineBreaks: true,
                    ghCodeBlocks: true,
                    tasklists: true,
                    tables: true,
                }
            );
            // Convert the Markdown description to HTML
            {% autoescape off %}
            document.getElementById("meeting-description").innerHTML = converter.makeHtml(`{{ meeting_description }}`);
            {% endautoescape %}
        })
        </script>
    {% endif %}
    <title>會議「{{ meeting.name }}」的資訊</title>
{% endblock %}

{% block main_content %}
    <div class="soft-container" id="meeting-info-container">
        <h1 style="margin: 0.3em 0;">會議「{{ meeting.name }}」的資訊</h1>
        <div id="meeting-panel">
            <div class="round-container panel" id="meeting-info-panel">
                <div class="panel-title" id="meeting-info-title">
                    <md-icon>event</md-icon>
                    <span class="panel-title-text">會議資訊</span>
                </div>
                <div id="meeting-info-content-container">
                <div class="meeting-info-content" id="meeting-info-content-1">
                    <p><strong>名稱：</strong>{{ meeting.name }}</p>
                    <div style="display: flex; align-items: center; height: min-content; margin-top: 1em;">
                        <p style="margin: 0;"><strong>可請假：</strong></p>
                        {% if meeting.can_absent %}
                            <md-icon style="color: #60ed60;">check_circle</md-icon>
                        {% else %}
                            <md-icon style="color: #fd7474;">cancel</md-icon>
                        {% endif %}
                    </div>
                    <div style="display: flex; align-items: center; height: min-content; margin-top: 1em;">
                        <p style="margin: 0;"><strong>主持人：</strong></p>
                        <div class="member-indicator">
                            <img src="{{ meeting.host.avatar }}" alt="主持人的頭像" class="member-avatar">
                            <span class="member-name">
                                {{ meeting.host.real_name }} ({{ meeting.host.discord_id }})
                            </span>
                        </div>
                    </div>
                    <p><strong>開始時間：</strong>{{ meeting.start_time|date:"Y/m/d H:i" }}</p>
                    {% if meeting.end_time %}
                        <p><strong>結束時間：</strong>{{ meeting.end_time|date:"Y/m/d H:i" }}</p>
                    {% endif %}
                    <p><strong>地點：</strong>{{ meeting.location }}</p>
                    {% if absent_request %}
                        <md-divider inset-end></md-divider>
                        <div style="display: flex; align-items: center; margin: 1em 0;">
                        <span><strong>假單狀態：</strong></span>
                        {% if absent_request.status == "pending" %}
                            <span class="material-symbols-outlined" style="color: #ffff5d;">pending</span>
                            <span style="margin-left: 0.2em;">待審核</span>
                        {% elif absent_request.status == "approved" %}
                            <span class="material-symbols-outlined" style="color: #60ed60;">check_circle</span>
                            <span style="margin-left: 0.2em;">已批准</span>
                        {% elif absent_request.status == "rejected" %}
                            <span class="material-symbols-outlined" style="color: #fd7474;">cancel</span>
                            <span style="margin-left: 0.2em;">已拒絕</span>
                        {% else %}
                            <span class="material-symbols-outlined" style="color: lightgray;">help_outline</span>
                            <span style="margin-left: 0.2em;">未知狀態</span>
                        {% endif %}
                        </div>
                        <p><strong>假單內容：</strong>{{ absent_request.reason }}</p>
                        <p><strong>假單提交時間：</strong>{{ absent_request.created_at }}</p>
                        {% if absent_request.reviewer %}
                            <div style="display: flex; align-items: center; height: min-content; margin-top: 1em;">
                                <p style="margin: 0;"><strong>假單審核者：</strong></p>
                                <div class="member-indicator">
                                    <img src="{{ absent_request.reviewer.avatar }}" alt="假單審核者的頭像" class="member-avatar">
                                    <span class="member-name">
                                        {{ absent_request.reviewer.real_name }} ({{ absent_request.reviewer.discord_id }})
                                    </span>
                                </div>
                            </div>
                        {% endif %}
                        {% if absent_request.reviewer_comment %}
                            <p><strong>審核者留言：</strong>{{ absent_request.reviewer_comment }}</p>
                        {% endif %}
                    {% endif %}
                </div>
                {% if meeting.description %}
                    <div class="meeting-info-content" id="meeting-info-content-2">
                        <p style="margin-bottom: 0.5em;"><strong>說明：</strong></p>
                        <div class="round-container inner-container" id="meeting-description">
                            <!-- Description will be injected here as HTML -->
                        </div>
                    </div>
                {% endif %}
                </div>
            </div>
            <div class="round-container panel" id="meeting-actions-panel">
                <div class="panel-title" id="meeting-actions-title">
                    <md-icon>action_key</md-icon>
                    <span class="panel-title-text">操作</span>
                </div>
                <div id="meeting-actions-content">
                    <md-filled-button href="./submit_absent_request" {% if not can_send_absent_request %} disabled {% endif %}>
                        <div style="display: flex; align-items: center; height: min-content;">
                            <span class="material-symbols-outlined button-icon">
                                assignment_add</span>
                            提交假單
                        </div>
                    </md-filled-button>
                    {% if reason_not_absent %}
                    <div style="display: flex; align-items: center;">
                        <span class="material-symbols-outlined" style="font-size: 1.2em; padding-top: 0.155em;">error</span>
                        <span style="margin-left: 0.2em; font-size: 0.8em;">{{ reason_not_absent }}</span>
                    </div>
                    {% endif %}
                    <md-divider></md-divider>
                    <md-filled-button href="./edit" {% if not can_edit %} disabled {% endif %}>
                        <div style="display: flex; align-items: center; height: min-content;">
                            <span class="material-symbols-outlined button-icon">
                                edit</span>
                            編輯會議
                        </div>
                    </md-filled-button>
                    <md-filled-button href="./review_absent_requests" {% if not can_edit %} disabled {% endif %}>
                        <div style="display: flex; align-items: center; height: min-content;">
                            <span class="material-symbols-outlined button-icon">
                                document_search</span>
                            審核假單
                        </div>
                    </md-filled-button>
                    <md-filled-button href="{% url "meeting_signin_create" meeting.pk %}"
                            {% if not can_sign_in %} disabled {% endif %}>
                        <div style="display: flex; align-items: center; height: min-content;">
                            <span class="material-symbols-outlined button-icon">
                                splitscreen_add</span>
                            新增簽到階段
                        </div>
                    </md-filled-button>
                </div>
            </div>
        </div>
        <div class="round-container list-container">
            <div class="list-container-title">
                <div class="panel-title">
                    <span class="material-symbols-outlined panel-title-icon">search_check_2</span>
                    <span class="panel-title-text">已審核的假單</span>
                </div>
                <span class="material-symbols-outlined panel-title-icon collapse-button"
                      id="absent-request-collapse-button">
                    keyboard_arrow_down</span>
            </div>
            <div class="round-container list-content" id="absent-request-list-content">
                <md-list id="absent-request-list" style="width: 100%;">
                    <md-list-item>
                        <div class="list-item">
                            <span class="item-text absent-request-member"><strong>成員</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text absent-request-reason"><strong>事由</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text absent-request-result"><strong>結果</strong></span>
                        </div>
                    </md-list-item>
                    <div class="divider"></div>
                    {% for absent_request in reviewed_absent_requests %}
                        <md-list-item>
                            <div class="list-item">
                                <div class="absent-request-member member-indicator">
                                    <img src="{{ absent_request.member.avatar }}"
                                         alt="{{ absent_request.member.real_name }} 的頭像"
                                         class="member-avatar">
                                    <span class="member-name" style="color: black;">
                                        {{ absent_request.member.real_name }} ({{ absent_request.member.discord_id }})
                                    </span>
                                </div>
                                <div class="vertical-spacer"></div>
                                <span class="item-text absent-request-reason">
                                    {{ absent_request.reason }}
                                </span>
                                <div class="vertical-spacer"></div>
                                <div class="absent-request-result">
                                    {% if absent_request.status == "approved" %}
                                        <span class="material-symbols-outlined" style="color: #3eff3e;">
                                            check_circle</span>
                                    {% elif absent_request.status == "rejected" %}
                                        <span class="material-symbols-outlined" style="color: #ff4c4c;">
                                            cancel</span>
                                    {% endif %}
                                </div>
                            </div>
                        </md-list-item>
                        <div class="divider"></div>
                    {% empty %}
                        <md-list-item>尚無審核過的假單</md-list-item>
                    {% endfor %}
                </md-list>
            </div>
        </div>
        {% if can_sign_in %}
        <div class="round-container list-container">
            <div class="list-container-title">
                <div class="panel-title">
                    <span class="material-symbols-outlined panel-title-icon">splitscreen</span>
                    <span class="panel-title-text">已建立的簽到階段</span>
                </div>
                <span class="material-symbols-outlined panel-title-icon collapse-button" id="sign-in-collapse-button">
                    keyboard_arrow_down</span>
            </div>
            <div class="round-container list-content" id="sign-in-list-content">
                <md-list id="sign-in-list" style="width: 100%;">
                    <md-list-item>
                        <div class="list-item">
                            <span class="item-text sign-in-uuid"><strong>UUID</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text sign-in-creator"><strong>建立者</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text sign-in-period"><strong>期限</strong></span>
                        </div>
                    </md-list-item>
                    <div class="divider"></div>
                    {% for sign_in in sign_ins %}
                        <md-list-item href="{% url "meeting_signin_scan" meeting.pk sign_in.uuid %}" target="_blank">
                            <div class="list-item">
                                <span class="item-text sign-in-uuid">{{ sign_in.uuid }}</span>
                                <div class="vertical-spacer"></div>
                                <div class="sign-in-creator member-indicator">
                                    <img src="{{ sign_in.creator.avatar }}" alt="{{ sign_in.creator.real_name }} 的頭像"
                                         class="member-avatar">
                                    <span class="member-name" style="color: black;">
                                        {{ sign_in.creator.real_name }} ({{ sign_in.creator.discord_id }})
                                    </span>
                                </div>
                                <div class="vertical-spacer"></div>
                                <div class="sign-in-period time-container">
                                    <span class="item-text">{{ sign_in.started_at }}</span>
                                    <span class="item-text material-symbols-outlined" style="font-size: medium">arrow_downward</span>
                                    <span class="item-text">{{ sign_in.ended_at }}</span>
                                </div>
                            </div>
                        </md-list-item>
                        <div class="divider"></div>
                    {% empty %}
                        <md-list-item>尚無簽到階段</md-list-item>
                    {% endfor %}
                </md-list>
            </div>
        </div>
        {% endif %}
        <div class="round-container list-container">
            <div class="panel-title">
                <span class="material-symbols-outlined panel-title-icon">list</span>
                <span class="panel-title-text">簽到紀錄</span>
            </div>
            <div class="round-container list-content" id="record-list-content">
                <md-list id="record-list" style="width: 100%;">
                    <md-list-item>
                        <div class="list-item">
                            <span class="item-text record-member"><strong>成員</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text record-method"><strong>簽到階段 ID</strong></span>
                            <div class="vertical-spacer"></div>
                            <span class="item-text record-signed-at"><strong>簽到時間</strong></span>
                        </div>
                    </md-list-item>
                    <div class="divider"></div>
                    {% for record in records %}
                        <md-list-item>
                            <div class="list-item">
                                <div class="record-member member-indicator">
                                    <img src="{{ record.member.avatar }}" alt="{{ record.member.real_name }} 的頭像"
                                         class="member-avatar">
                                    <span class="member-name" style="color: black;">
                                        {{ record.member.real_name }} ({{ record.member.discord_id }})
                                    </span>
                                </div>
                                <div class="vertical-spacer"></div>
                                <span class="item-text record-method">
                                    {{ record.sign_in_uuid|slice:"0:8" }}...
                                </span>
                                <div class="vertical-spacer"></div>
                                <span class="item-text record-signed-at">
                                    {{ record.signed_in_at }}
                                </span>
                            </div>
                        </md-list-item>
                        <div class="divider"></div>
                    {% empty %}
                        <md-list-item>尚無簽到記錄</md-list-item>
                    {% endfor %}
                </md-list>
            </div>
        </div>
    </div>
{% endblock %}